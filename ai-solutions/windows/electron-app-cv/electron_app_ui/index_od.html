<!DOCTYPE html>
<html>

<head>
    <title>AI Solutions</title>
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->
	  <link rel="stylesheet" href="assets/web/assets/mobirise-icons2/mobirise2.css">
	  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
	  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
	  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
	  <link rel="stylesheet" href="assets/animatecss/animate.css">
	  <link rel="stylesheet" href="assets/dropdown/css/style.css">
	  <link rel="stylesheet" href="assets/theme/css/style.css">
    <style>
      html {
        box-sizing: border-box;
      }
      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }
      body {
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .container {
        position: relative;
        margin: 0 auto;
        /* Center the container horizontally */
        width: 640px;
        height: 480px;
        border: 0px solid white;
        text-align: center;
      }
	  .loader {
		position: absolute;
		margin: 0 auto;
		/* Center the container horizontally */
		  border: 16px solid #f3f3f3; /* Light grey */
		  border-top: 16px solid #3498db; /* Blue */
		  border-radius: 50%;
		  top:40%;
		  left:40%;
		  width: 120px;
		  height: 120px;
		  animation: spin 2s linear infinite;
		}

		@keyframes spin {
		  0% { transform: rotate(0deg); }
		  100% { transform: rotate(360deg); }
		}
      .dimensionbox {
        position: absolute;
        margin: 0 auto;
        text-align: center;
        font-size: 20px;
        border: 2px solid white;
      }
      .headingbox {
        position: absolute;
        margin: 0 auto;
        text-align: center;
        font-size: 20px;
        border: 2px solid white;
      }
      .timerbox {
        position: absolute;
        top: 540px;
        margin: 0 auto;
        width: 100%;
        text-align: center;
        display: inline-block;
        border: 2px solid white;
      }
      .action-btn {
        cursor: pointer;
        background-color: #1b05e2;
        color: #fff;
        border: none;
        margin: 10px;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
        transition: background-color 0.3s;
      }
      .action-btn:hover {
        background-color: #0beb74;
      }
      .wrapper {
        display: flex;
      }

	  
      #sidebar {
        width: 250px;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 10px;
        background-color: #f8f9fa;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      #content {
        flex: 1;
        margin-left: 250px;
        padding: 20px;
      }
      .ai-title {
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
      }
      .separator {
            margin: 0px 0;
            border-top: 1px solid #bbb;
      }
		.nav-link{
			padding: 20px;
			border-top-right-radius: 40px; border-bottom-right-radius: 40px;
			list-style-type: disc;
			color: #000000;
		}
		.nav-link img {
		  width: 20px; /* adjust size as needed */
		  margin-right: 10px; /* adjust spacing as needed */
		}
		.nav-link span {
		  display: flex;
		  align-items: center;
		}

		.nav-link:hover {
		  background-color: #e6e7e8;
		  color: #0a06d1;
		  border-top-right-radius: 40px;
		  border-bottom-right-radius: 40px;
		}
      .dropdown {
        margin-top: 20px;
      }
      .dropdown label {
        display: block;
        font-weight: bold;
      }
      .dropdown select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-top: 5px;
      }
      .btn-group-sidebar {
        margin-top: 20px;
      }
      .btn-group-sidebar label {
        display: block;
        font-weight: bold;
      }
      .btn-group-wrap {
        text-align: right;
      }
      .btn-group .text {
        margin-right: 10px;
      }
      /* Right sidebar */
      #right-sidebar {
        width: 250px;
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        z-index: 100;
        padding: 10px;
        background-color: #f8f9fa;
        overflow-y: auto;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
        <nav id="sidebar">
            <h2 class="ai-title">AI Demos</h2>
			<ul class="list-unstyled content">
			<li><a href="ai-solutions.html" class="nav-link" style = "padding: 20px"><span><img src="assets\images\Ionic-Ionicons-Home-sharp.512.png" alt="Icon">Home</span></a></li>
			<li class="separator" ></li>
                <li><a href="index_sr.html" class="nav-link">Super Resolution</a></li>
				<li><a href="index_ie.html" class="nav-link" id = "lowlighttab">Image Enhancement</a></li>
                <li><a href="index_od.html" class="nav-link" style = "background-color: #d4eefc; color: #0a06d1">Object Detection</a></li>
                <li><a href="index_is.html" class="nav-link">Image Segmentation</a></li>
                <!-- Add more AI demos as needed... -->
            </ul>
        </nav>

      <nav id="right-sidebar">
        <div class="dropdown">
          <label for="model-dropdown">Select Model:</label>
		  <span style="display: inline-block; position: relative; width: 100%;">
          <select id="model-dropdown" class="form-control">
            <option value="yolonas">YOLO-NAS</option>
            <option value="mobilenetssd">MOBILENET</option>
			<option value="yolox">YOLOX</option>
            <!-- Add more model options as needed... -->
          </select>
		  <img src="assets\images\dropdown.png" style="width: 20px; position: absolute; top: 50%; right: 0; transform: translateY(-50%); margin-right:20px; pointer-events: none;">
		  </span>
        </div>
        <div class="dropdown">
          <label for="runtime-dropdown">Select Runtime:</label>
		  <span style="display: inline-block; position: relative; width: 100%;">
          <select id="runtime-dropdown" class="form-control">
            <option value="DSP">DSP</option>
            <option value="CPU">CPU</option>
          </select>
		  <img src="assets\images\dropdown.png" style="width: 20px; position: absolute; top: 50%; right: 0; transform: translateY(-50%); margin-right:20px; pointer-events: none;">
		  </span>
        </div>
        <div class="btn-group-sidebar" style="visibility: hidden; display: none ">
          <label>Frames Per Second:</label>
          <div class="btn-group-wrap">
            <div class="btn-group" role="group">
              <div id="fps" class="text">30</div>
              <button id="dec-fps-btn" type="button" class="btn btn-outline-secondary btn-sm">
                -
              </button>
              <button id="inc-fps-btn" type="button" class="btn btn-outline-secondary btn-sm">
                +
              </button>
            </div>
          </div>
        </div>
		<div class="btn-group-sidebar">
          <label>Output Frames Per Second:</label>
          <div class="btn-group-wrap">
            <div class="btn-group" role="group">
              <div id="outfps" class="text">30</div>
            </div>
          </div>
        </div>
        <br />
        <!-- Add more thumbnails as needed... -->
      </nav>
    </div>

    <div
      class="headingbox"
      id="headingboxid"
      style="visibility: visible; position: absolute; top: 1%;left: 50%; transform: translateX(-50%);"
    >
      <h1>Object Detection</h1>
    </div>
    <div class="container">
      <!-- <div class="img background-img"></div> -->
	  <div class="loader" id = "loaderid" style="visibility: hidden"></div>
      <video id="video" width="640" height="480" hidden></video>
      <canvas id="canvas" width="640" height="480" hidden></canvas>
      <img id="img" width="640" height="480" />
	  
      <button id="inference-button" class="action-btn">Run Inference</button>

      <div class="timerbox" id="timerboxid" style="visibility: hidden; left: 2%">
        <h1 id="timerboxheading">Inference time : 21.00 ms</h1>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
      integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
      crossorigin="anonymous"
    ></script>
    <script>
      $(document).ready(function () {
        var intervalId;
        var detection = false;
		var build_model = false;
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var img = document.getElementById("img");
        var fps = document.getElementById("fps");
        var outfps = document.getElementById("outfps");
        var runtime = document.getElementById("runtime-dropdown");
        var model = document.getElementById("model-dropdown");
        var formData_model = new FormData();
        var formData = new FormData();
        var urlCreator = window.URL || window.webkitURL;
		
		var loader = document.getElementById("loaderid");
		var inferbut = document.getElementById("inference-button");
			
        canvas.width = 640;
        canvas.height = 480;
        fps.textContent = 15;


		function startloadscreen(){
			console.log("button disabled");
			inferbut.disabled = true;
			loader.style.visibility="visible";
			
		}
		
		function stoploadscreen(){
			console.log("button enabled");
			inferbut.disabled = false;
			loader.style.visibility = "hidden";
			fps.textContent = 15;
		}
		
        function display() {
          context.clearRect(0, 0, canvas.width, canvas.height);
          context.drawImage(video, 0, 0);
          canvas.toBlob((blob) => {
			
            if (detection && build_model) {
				console.log("Camera Sample detection and build is true:")
              formData.set("image_data", blob, "image.jpeg");

              start = Date.now();
              $.ajax({
                url: "http://127.0.0.1:9081/object_detection",
                type: "POST",
                async: true,
                data: formData,
                processData: false, // Prevents jQuery from converting the data to a string
                contentType: false, // Let jQuery set the content type automatically for FormData
                xhrFields: { responseType: "arraybuffer" },
                success: function (data) {
                  try {
                    // console.log("SUCCESS");

                    var blob = new Blob([new Uint8Array(data)], { type: "image/jpeg" });
                    const end = Date.now();
                    console.log(`Execution time: ${end - start} ms`);
					outfps.textContent = Math.floor(1000/(end-start));
                    img.src = urlCreator.createObjectURL(blob);
                  } catch (e) {
                    console.log(e);
                    $("#inference-button").text("Run Inference");
					<!-- window.clearInterval(intervalId); -->
                    detection = false;
                  }
                },
                error: function (ret) {
                  <!-- console.error("Error while handling img resp:", error); -->
                  <!-- console.error("flushing frames"); -->
                  console.error("somer erro from python server for some frames");
                  <!-- console.error("status", status); -->
                  <!-- $("#inference-button").text("Run Inference"); -->
				  <!-- window.clearInterval(intervalId); -->
                  <!-- detection = false; -->
                },
              });

              <!-- for (var key of formData.keys()) { -->
                <!-- formData.delete(key); -->
              <!-- } -->
            } else {
				console.log("detection", detection, "buildmodel", build_model)
				<!-- console.log("Camera Sample detection is :", detection) -->
				<!-- console.log("Camera Sample buildmodel is :", build_model) -->
				<!-- console.log("Camera Sample buildmodel is :", build_model) -->
              img.src = urlCreator.createObjectURL(blob);
            }
          }, "image/jpeg");
        }

        function cameraSample(_fps) {
          window.clearInterval(intervalId);
		  console.log("FPS is: ", _fps)
          intervalId = window.setInterval(() => {
            display();
          }, 1000 / _fps);
        }

        navigator.mediaDevices
          .getUserMedia({
            audio: false,
            video: {
              facingMode: "environment",
              width: { max: canvas.width },
              height: { max: canvas.height },
            },
          })
          .then((stream) => {
            video.srcObject = stream;
            video.onloadedmetadata = () => video.play();
          })
          .catch((error) => {
            alert(JSON.stringify(error));
          });

        $("#dec-fps-btn").click(function () {
          if (fps.textContent > 1) --fps.textContent;
        });

        $("#inc-fps-btn").click(function () {
          if (fps.textContent < 30) ++fps.textContent;
        });

        $("#inference-button").click(function () {
		  
		  detection = !detection;
		  if(detection){
			console.log("Detection is true");
			
		  var exit_flag = 0;
			$.ajax({
				url: 'http://localhost:9081/od_checkdlc',
				method: 'POST',
				responseType: 'json',
				data:{ 'model_name':  model.value }, 
				async: false,
				success: function (data) {							
					if(data.dlc_available=="yes"){
						console.log("DLC is present", data.dlc_path	);
					}
					else if (data.dlc_available=="no"){
						alert ("DLC Not Available at " + data.dlc_path);
						console.log("This is a warning message!", data.dlc_path);
						$('#inference-button').text('Run Inference'); // Reset the button text
						exit_flag = 1;

					}
					else{
						console.log("outofif");
					}
				},
				error: (data) => {
					console.log("ERROR");
					exit_flag = 1;
				}
			});
		  
		  if (exit_flag==1)
			{
			detection = !detection;
			return;
			}
			console.log("Building model");
			startloadscreen();
				formData_model.set("model_name", model.value);
                formData_model.set("runtime_name", runtime.value);
				
				console.log("model.value: ", model.value);
				
				<!-- Disable followinf for dynamic FPS -->
				if (runtime.value === "CPU") fps.textContent = 1;
				if (runtime.value === "DSP") fps.textContent = 15;
			
				$.ajax({
						url: 'http://localhost:9081/od_build_model',
						type: "POST",
						async: true,
						data: formData_model,
						processData: false, // Prevents jQuery from converting the data to a string
						contentType: false, // Let jQuery set the content type automatically for formData_model
						<!-- xhrFields: { responseType: "arraybuffer" }, -->
						responseType: 'json',
						success: function (data) {
							console.log("build successful")
							build_model= true;
							stoploadscreen();
						
						},
						error: (data) => {
							console.log("ERROR in building model");
							build_model = false;
							stoploadscreen();
						}
						});
		  }
		  else{
				console.log("Stop inference");
				detection = false;
				build_model = false;
				<!-- Sending request to flask server to flushing all detection requests in queue -->
				startloadscreen();
				$.ajax({
						url: 'http://localhost:9081/od_stop_infer',
						method: 'POST',
						responseType: 'json',
						beforeSend: function(xhr) {
							xhr.setRequestHeader('X-Priority', 'high');
						},
						success: function (data) {
						try {
							console.log("STOPPED INFER");
							stoploadscreen();
							
						} catch (e) {
							console.log(e);
							stoploadscreen();
						}
						},
						error: (data) => {
							console.log("ERROR in stop infer");
							stoploadscreen();
							<!-- console.log(data); -->
							$('#inference-button').text('Run Inference'); // Reset the button text
						}
					});
		  }
          cameraSample(fps.textContent);
          const buttonLabel = detection ? "Stop Inference" : "Run Inference";
		  console.log("button Label: ",buttonLabel);
          $("#inference-button").text(buttonLabel);
        });

        cameraSample(fps.textContent);
      });
    </script>
  </body>
</html>
